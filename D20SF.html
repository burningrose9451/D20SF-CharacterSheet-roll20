<!-- D20SF Character Sheet for Roll20 -->
<div class="sheet-character-sheet">
    <!-- Tab Navigation -->
    <div class="sheet-tab-navigation">
        <input type="radio" name="attr_sheet_tab" class="sheet-tab sheet-tab1" value="character" checked="checked">
        <span class="sheet-tab-label" title="Character">Character</span>
        
        <input type="radio" name="attr_sheet_tab" class="sheet-tab sheet-tab2" value="abilities">
        <span class="sheet-tab-label" title="Abilities">Abilities</span>
        
        <input type="radio" name="attr_sheet_tab" class="sheet-tab sheet-tab3" value="inventory">
        <span class="sheet-tab-label" title="Inventory">Inventory</span>
        
        <input type="radio" name="attr_sheet_tab" class="sheet-tab sheet-tab4" value="notes">
        <span class="sheet-tab-label" title="Notes">Notes</span>
    </div>

    <!-- Character Tab -->
    <div class="sheet-tab-content sheet-tab-character">
        <div class="sheet-section">
            <h2>Character Information</h2>
            
            <div class="sheet-2-columns">
                <div class="sheet-column">
                    <label>Character Name:</label>
                    <input type="text" name="attr_character_name" />
                </div>
                
                <div class="sheet-column">
                    <label>Player Name:</label>
                    <input type="text" name="attr_player_name" />
                </div>
            </div>
            
            <div class="sheet-3-columns">
                <div class="sheet-column">
                    <label>Level:</label>
                    <input type="number" name="attr_level" value="1" />
                </div>
                
                <div class="sheet-column">
                    <label>Experience:</label>
                    <input type="number" name="attr_experience" value="0" />
                </div>
                
                <div class="sheet-column">
                    <label>Class:</label>
                    <input type="text" name="attr_class" />
                </div>
            </div>
            
            <div class="sheet-2-columns">
                <div class="sheet-column">
                    <label>Proficiency Bonus:</label>
                    <input type="number" name="attr_proficiency_bonus" value="2" disabled />
                    <small>(Auto-calculated from level)</small>
                </div>
            </div>
        </div>

        <!-- Core Attributes -->
        <div class="sheet-section">
            <h2>Core Attributes</h2>
            
            <div class="sheet-attributes-grid">
                <div class="sheet-attribute">
                    <label>Strength:</label>
                    <input type="number" name="attr_strength" value="10" />
                    <label class="sheet-mod-label">Modifier:</label>
                    <input type="number" name="attr_strength_mod" value="0" class="sheet-mod-input" />
                    <button type="roll" name="roll_strength" value="&{template:default} {{name=Strength Check}} {{roll=[[1d20+@{strength_mod}]]}}">
                        Roll
                    </button>
                </div>
                
                <div class="sheet-attribute">
                    <label>Dexterity:</label>
                    <input type="number" name="attr_dexterity" value="10" />
                    <label class="sheet-mod-label">Modifier:</label>
                    <input type="number" name="attr_dexterity_mod" value="0" class="sheet-mod-input" />
                    <button type="roll" name="roll_dexterity" value="&{template:default} {{name=Dexterity Check}} {{roll=[[1d20+@{dexterity_mod}]]}}">
                        Roll
                    </button>
                </div>
                
                <div class="sheet-attribute">
                    <label>Constitution:</label>
                    <input type="number" name="attr_constitution" value="10" />
                    <label class="sheet-mod-label">Modifier:</label>
                    <input type="number" name="attr_constitution_mod" value="0" class="sheet-mod-input" />
                    <button type="roll" name="roll_constitution" value="&{template:default} {{name=Constitution Check}} {{roll=[[1d20+@{constitution_mod}]]}}">
                        Roll
                    </button>
                </div>
                
                <div class="sheet-attribute">
                    <label>Intelligence:</label>
                    <input type="number" name="attr_intelligence" value="10" />
                    <label class="sheet-mod-label">Modifier:</label>
                    <input type="number" name="attr_intelligence_mod" value="0" class="sheet-mod-input" />
                    <button type="roll" name="roll_intelligence" value="&{template:default} {{name=Intelligence Check}} {{roll=[[1d20+@{intelligence_mod}]]}}">
                        Roll
                    </button>
                </div>
                
                <div class="sheet-attribute">
                    <label>Wisdom:</label>
                    <input type="number" name="attr_wisdom" value="10" />
                    <label class="sheet-mod-label">Modifier:</label>
                    <input type="number" name="attr_wisdom_mod" value="0" class="sheet-mod-input" />
                    <button type="roll" name="roll_wisdom" value="&{template:default} {{name=Wisdom Check}} {{roll=[[1d20+@{wisdom_mod}]]}}">
                        Roll
                    </button>
                </div>
                
                <div class="sheet-attribute">
                    <label>Charisma:</label>
                    <input type="number" name="attr_charisma" value="10" />
                    <label class="sheet-mod-label">Modifier:</label>
                    <input type="number" name="attr_charisma_mod" value="0" class="sheet-mod-input" />
                    <button type="roll" name="roll_charisma" value="&{template:default} {{name=Charisma Check}} {{roll=[[1d20+@{charisma_mod}]]}}">
                        Roll
                    </button>
                </div>
            </div>
        </div>

        <!-- Health & Resources -->
        <div class="sheet-section">
            <h2>Health & Resources</h2>
            
            <div class="sheet-3-columns">
                <div class="sheet-column">
                    <label>Hit Points:</label>
                    <input type="number" name="attr_hp" value="0" />
                    <span>/</span>
                    <input type="number" name="attr_hp_max" value="0" />
                </div>
                
                <div class="sheet-column">
                    <label>Armor Class:</label>
                    <input type="number" name="attr_ac" value="10" />
                </div>
                
                <div class="sheet-column">
                    <label>Initiative:</label>
                    <input type="number" name="attr_initiative" value="0" />
                    <button type="roll" name="roll_initiative" value="&{template:default} {{name=Initiative}} {{roll=[[1d20+@{initiative}]]}}">
                        Roll
                    </button>
                </div>
            </div>
        </div>

        <!-- Repeating Skills Section -->
        <div class="sheet-section">
            <h2>Skills</h2>
            
            <fieldset class="repeating_skills">
                <div class="sheet-skill-row">
                    <input type="text" name="attr_skill_name" placeholder="Skill Name" />
                    <input type="number" name="attr_skill_bonus" value="0" placeholder="Bonus" />
                    <button type="roll" name="roll_skill" value="&{template:default} {{name=@{skill_name}}} {{roll=[[1d20+@{skill_bonus}]]}}">
                        Roll
                    </button>
                    <input type="checkbox" name="attr_skill_proficient" value="1" />
                    <label>Proficient</label>
                </div>
            </fieldset>
            
            <div class="sheet-add-button">
                <button type="action" name="act_add_skill">Add Skill</button>
            </div>
        </div>
    </div>

    <!-- Abilities Tab -->
    <div class="sheet-tab-content sheet-tab-abilities">
        <div class="sheet-section">
            <h2>Special Abilities</h2>
            
            <fieldset class="repeating_abilities">
                <div class="sheet-ability-row">
                    <div class="sheet-ability-header">
                        <input type="text" name="attr_ability_name" placeholder="Ability Name" />
                        <input type="text" name="attr_ability_type" placeholder="Type (Active/Passive)" />
                    </div>
                    <div class="sheet-ability-details">
                        <label>Uses:</label>
                        <input type="number" name="attr_ability_uses" value="0" />
                        <span>/</span>
                        <input type="number" name="attr_ability_uses_max" value="0" />
                    </div>
                    <div class="sheet-ability-description">
                        <label>Description:</label>
                        <textarea name="attr_ability_description" placeholder="Describe the ability..."></textarea>
                    </div>
                    <div class="sheet-ability-roll">
                        <label>Roll Formula:</label>
                        <input type="text" name="attr_ability_roll" placeholder="e.g., 1d20+5" />
                        <button type="roll" name="roll_ability" value="&{template:default} {{name=@{ability_name}}} {{roll=[[@{ability_roll}]]}} {{description=@{ability_description}}}">
                            Roll
                        </button>
                    </div>
                </div>
            </fieldset>
            
            <div class="sheet-add-button">
                <button type="action" name="act_add_ability">Add Ability</button>
            </div>
        </div>

        <!-- Repeating Feats Section -->
        <div class="sheet-section">
            <h2>Feats & Traits</h2>
            
            <fieldset class="repeating_feats">
                <div class="sheet-feat-row">
                    <input type="text" name="attr_feat_name" placeholder="Feat Name" />
                    <textarea name="attr_feat_description" placeholder="Description..."></textarea>
                </div>
            </fieldset>
            
            <div class="sheet-add-button">
                <button type="action" name="act_add_feat">Add Feat/Trait</button>
            </div>
        </div>
    </div>

    <!-- Inventory Tab -->
    <div class="sheet-tab-content sheet-tab-inventory">
        <div class="sheet-section">
            <h2>Weapons</h2>
            
            <fieldset class="repeating_weapons">
                <div class="sheet-weapon-row">
                    <input type="text" name="attr_weapon_name" placeholder="Weapon Name" />
                    <input type="text" name="attr_weapon_damage" placeholder="Damage (e.g., 1d8)" />
                    <input type="text" name="attr_weapon_type" placeholder="Type" />
                    <input type="number" name="attr_weapon_bonus" value="0" placeholder="Bonus" />
                    <button type="roll" name="roll_weapon_attack" value="&{template:default} {{name=@{weapon_name} Attack}} {{Attack Roll=[[1d20+@{weapon_bonus}]]}} {{Damage=[[(@{weapon_damage})]]}} {{Damage Bonus=[[+@{weapon_bonus}]]}}">
                        Attack
                    </button>
                </div>
            </fieldset>
            
            <div class="sheet-add-button">
                <button type="action" name="act_add_weapon">Add Weapon</button>
            </div>
        </div>

        <div class="sheet-section">
            <h2>Armor</h2>
            
            <fieldset class="repeating_armor">
                <div class="sheet-armor-row">
                    <input type="text" name="attr_armor_name" placeholder="Armor Name" />
                    <input type="number" name="attr_armor_ac" value="0" placeholder="AC Bonus" />
                    <input type="text" name="attr_armor_type" placeholder="Type" />
                    <input type="checkbox" name="attr_armor_equipped" value="1" />
                    <label>Equipped</label>
                </div>
            </fieldset>
            
            <div class="sheet-add-button">
                <button type="action" name="act_add_armor">Add Armor</button>
            </div>
        </div>

        <div class="sheet-section">
            <h2>General Inventory</h2>
            
            <fieldset class="repeating_inventory">
                <div class="sheet-inventory-row">
                    <input type="text" name="attr_item_name" placeholder="Item Name" />
                    <input type="number" name="attr_item_quantity" value="1" placeholder="Qty" />
                    <input type="text" name="attr_item_weight" placeholder="Weight" />
                    <textarea name="attr_item_description" placeholder="Description..."></textarea>
                </div>
            </fieldset>
            
            <div class="sheet-add-button">
                <button type="action" name="act_add_item">Add Item</button>
            </div>
        </div>

        <div class="sheet-section">
            <h2>Currency</h2>
            
            <div class="sheet-currency-grid">
                <div class="sheet-currency">
                    <label>Gold:</label>
                    <input type="number" name="attr_gold" value="0" />
                </div>
                <div class="sheet-currency">
                    <label>Silver:</label>
                    <input type="number" name="attr_silver" value="0" />
                </div>
                <div class="sheet-currency">
                    <label>Copper:</label>
                    <input type="number" name="attr_copper" value="0" />
                </div>
            </div>
        </div>
    </div>

    <!-- Notes Tab -->
    <div class="sheet-tab-content sheet-tab-notes">
        <div class="sheet-section">
            <h2>Character Background</h2>
            <textarea name="attr_background" placeholder="Write your character's background story..."></textarea>
        </div>

        <div class="sheet-section">
            <h2>Appearance</h2>
            <textarea name="attr_appearance" placeholder="Describe your character's appearance..."></textarea>
        </div>

        <div class="sheet-section">
            <h2>Additional Notes</h2>
            
            <fieldset class="repeating_notes">
                <div class="sheet-note-row">
                    <input type="text" name="attr_note_title" placeholder="Note Title" />
                    <textarea name="attr_note_content" placeholder="Note content..."></textarea>
                </div>
            </fieldset>
            
            <div class="sheet-add-button">
                <button type="action" name="act_add_note">Add Note</button>
            </div>
        </div>
    </div>
</div>

<script type="text/worker">
/* D20SF Character Sheet - Sheet Workers (JavaScript) */

/* ===== ATTRIBUTE MODIFIER CALCULATIONS ===== */

/**
 * Calculate ability modifier from ability score
 * Standard D&D formula: (score - 10) / 2, rounded down
 */
const calculateModifier = (score) => {
    return Math.floor((score - 10) / 2);
};

/**
 * Auto-calculate attribute modifiers when ability scores change
 */
const attributes = ['strength', 'dexterity', 'constitution', 'intelligence', 'wisdom', 'charisma'];

attributes.forEach(attr => {
    on(`change:${attr}`, function(eventInfo) {
        getAttrs([attr], function(values) {
            const score = parseInt(values[attr]) || 10;
            const modifier = calculateModifier(score);
            
            setAttrs({
                [`${attr}_mod`]: modifier
            });
        });
    });
});

/* ===== INITIATIVE CALCULATION ===== */

/**
 * Update initiative when dexterity modifier changes
 */
on('change:dexterity_mod', function(eventInfo) {
    getAttrs(['dexterity_mod'], function(values) {
        const dexMod = parseInt(values.dexterity_mod) || 0;
        
        setAttrs({
            initiative: dexMod
        });
    });
});

/* ===== REPEATING SECTION: ADD BUTTONS ===== */

/**
 * Add new skill when "Add Skill" button is clicked
 */
on('clicked:add_skill', function(eventInfo) {
    getSectionIDs('repeating_skills', function(ids) {
        const newRowId = generateRowID();
        const newRowAttrs = {};
        newRowAttrs[`repeating_skills_${newRowId}_skill_name`] = 'New Skill';
        newRowAttrs[`repeating_skills_${newRowId}_skill_bonus`] = 0;
        newRowAttrs[`repeating_skills_${newRowId}_skill_proficient`] = 0;
        
        setAttrs(newRowAttrs);
    });
});

/**
 * Add new ability when "Add Ability" button is clicked
 */
on('clicked:add_ability', function(eventInfo) {
    getSectionIDs('repeating_abilities', function(ids) {
        const newRowId = generateRowID();
        const newRowAttrs = {};
        newRowAttrs[`repeating_abilities_${newRowId}_ability_name`] = 'New Ability';
        newRowAttrs[`repeating_abilities_${newRowId}_ability_type`] = 'Active';
        newRowAttrs[`repeating_abilities_${newRowId}_ability_uses`] = 0;
        newRowAttrs[`repeating_abilities_${newRowId}_ability_uses_max`] = 0;
        
        setAttrs(newRowAttrs);
    });
});

/**
 * Add new feat when "Add Feat/Trait" button is clicked
 */
on('clicked:add_feat', function(eventInfo) {
    getSectionIDs('repeating_feats', function(ids) {
        const newRowId = generateRowID();
        const newRowAttrs = {};
        newRowAttrs[`repeating_feats_${newRowId}_feat_name`] = 'New Feat';
        
        setAttrs(newRowAttrs);
    });
});

/**
 * Add new weapon when "Add Weapon" button is clicked
 */
on('clicked:add_weapon', function(eventInfo) {
    getSectionIDs('repeating_weapons', function(ids) {
        const newRowId = generateRowID();
        const newRowAttrs = {};
        newRowAttrs[`repeating_weapons_${newRowId}_weapon_name`] = 'New Weapon';
        newRowAttrs[`repeating_weapons_${newRowId}_weapon_damage`] = '1d6';
        newRowAttrs[`repeating_weapons_${newRowId}_weapon_bonus`] = 0;
        
        setAttrs(newRowAttrs);
    });
});

/**
 * Add new armor when "Add Armor" button is clicked
 */
on('clicked:add_armor', function(eventInfo) {
    getSectionIDs('repeating_armor', function(ids) {
        const newRowId = generateRowID();
        const newRowAttrs = {};
        newRowAttrs[`repeating_armor_${newRowId}_armor_name`] = 'New Armor';
        newRowAttrs[`repeating_armor_${newRowId}_armor_ac`] = 0;
        newRowAttrs[`repeating_armor_${newRowId}_armor_equipped`] = 0;
        
        setAttrs(newRowAttrs);
    });
});

/**
 * Add new item when "Add Item" button is clicked
 */
on('clicked:add_item', function(eventInfo) {
    getSectionIDs('repeating_inventory', function(ids) {
        const newRowId = generateRowID();
        const newRowAttrs = {};
        newRowAttrs[`repeating_inventory_${newRowId}_item_name`] = 'New Item';
        newRowAttrs[`repeating_inventory_${newRowId}_item_quantity`] = 1;
        
        setAttrs(newRowAttrs);
    });
});

/**
 * Add new note when "Add Note" button is clicked
 */
on('clicked:add_note', function(eventInfo) {
    getSectionIDs('repeating_notes', function(ids) {
        const newRowId = generateRowID();
        const newRowAttrs = {};
        newRowAttrs[`repeating_notes_${newRowId}_note_title`] = 'New Note';
        
        setAttrs(newRowAttrs);
    });
});

/* ===== ARMOR CLASS CALCULATION ===== */

/**
 * Calculate total AC from base AC and equipped armor
 * This recalculates whenever armor is equipped/unequipped or AC values change
 */
on('change:repeating_armor', function(eventInfo) {
    getSectionIDs('repeating_armor', function(ids) {
        const attrs = ['ac'];
        
        // Gather all armor attributes
        ids.forEach(id => {
            attrs.push(`repeating_armor_${id}_armor_ac`);
            attrs.push(`repeating_armor_${id}_armor_equipped`);
        });
        
        getAttrs(attrs, function(values) {
            let baseAC = parseInt(values.ac) || 10;
            let totalAC = baseAC;
            
            // Add AC from equipped armor
            ids.forEach(id => {
                const equipped = parseInt(values[`repeating_armor_${id}_armor_equipped`]) || 0;
                const armorAC = parseInt(values[`repeating_armor_${id}_armor_ac`]) || 0;
                
                if (equipped === 1) {
                    totalAC += armorAC;
                }
            });
            
            // Note: This is a simple additive model
            // You may want to implement different logic for your game system
            setAttrs({
                ac: totalAC
            });
        });
    });
});

/* ===== SHEET INITIALIZATION ===== */

/**
 * Initialize all modifiers when sheet opens
 * This ensures all calculated values are up to date
 */
on('sheet:opened', function(eventInfo) {
    getAttrs(['strength', 'dexterity', 'constitution', 'intelligence', 'wisdom', 'charisma'], function(values) {
        const updates = {};
        
        attributes.forEach(attr => {
            const score = parseInt(values[attr]) || 10;
            const modifier = calculateModifier(score);
            updates[`${attr}_mod`] = modifier;
        });
        
        // Also update initiative
        updates.initiative = parseInt(updates.dexterity_mod) || 0;
        
        setAttrs(updates);
    });
});

/* ===== PROFICIENCY BONUS CALCULATION ===== */

/**
 * Calculate proficiency bonus based on character level
 * Standard D&D 5e formula: +2 at level 1, increasing by 1 every 4 levels
 */
on('change:level', function(eventInfo) {
    getAttrs(['level'], function(values) {
        const level = parseInt(values.level) || 1;
        const proficiencyBonus = Math.floor((level - 1) / 4) + 2;
        
        setAttrs({
            proficiency_bonus: proficiencyBonus
        });
    });
});

/* ===== SKILL BONUS CALCULATION ===== */

/**
 * Auto-calculate skill bonuses when proficiency or relevant modifier changes
 * This is a simplified version - you may want to add attribute selection per skill
 */
on('change:repeating_skills:skill_proficient change:proficiency_bonus', function(eventInfo) {
    const repeatingAttrs = eventInfo.sourceAttribute.split('_');
    const rowId = repeatingAttrs[2];
    
    if (rowId) {
        getAttrs([
            `repeating_skills_${rowId}_skill_proficient`,
            `repeating_skills_${rowId}_skill_bonus`,
            'proficiency_bonus'
        ], function(values) {
            const isProficient = parseInt(values[`repeating_skills_${rowId}_skill_proficient`]) || 0;
            const profBonus = parseInt(values.proficiency_bonus) || 2;
            const baseBonus = parseInt(values[`repeating_skills_${rowId}_skill_bonus`]) || 0;
            
            // If proficient, add proficiency bonus
            if (isProficient === 1) {
                setAttrs({
                    [`repeating_skills_${rowId}_skill_bonus`]: baseBonus + profBonus
                });
            }
        });
    }
});
</script>
